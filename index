<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DREAMPLEX êµìœ¡ê³„íšì„œ ìƒì„±ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, 'SF Pro Display', 'SF Pro', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            padding: 60px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .logo {
            font-size: 4.5em;
            font-weight: 900;
            margin-bottom: 15px;
            letter-spacing: 8px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
            background: linear-gradient(45deg, #fff, #f0f0f0, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: -200% center; }
            50% { background-position: 200% center; }
        }

        .subtitle {
            font-size: 1.6em;
            font-weight: 300;
            opacity: 0.95;
            position: relative;
            z-index: 2;
            letter-spacing: 2px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .header-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50px;
            padding: 8px 20px;
            font-size: 0.9em;
            font-weight: 500;
            margin-top: 20px;
            letter-spacing: 1px;
        }
        
        .form-section {
            padding: 40px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #495057;
            font-size: 1.1em;
        }
        
        .school-select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .school-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .school-select:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            flex: 1;
            min-width: 200px;
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        
        .generate-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
            color: white;
            min-width: 120px;
        }
        
        .refresh-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
        }
        
        .refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            text-align: center;
            padding: 60px 30px;
            background: #f8f9fa;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading p {
            color: #666;
            font-size: 1.1em;
        }
        
        .plan-result {
            padding: 30px;
            overflow: visible !important;
            height: auto !important;
        }
        
        /* ìƒˆë¡œìš´ êµìœ¡ê³„íšì„œ ë””ìì¸ */
        .education-plan {
            background: white;
            position: relative;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* ì¥ì‹ìš© ì›í˜• ìš”ì†Œë“¤ */
        .education-plan::before {
            content: '';
            position: absolute;
            top: -50px;
            left: -50px;
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, #a8e6cf 0%, #7fcdcd 100%);
            border-radius: 50%;
            opacity: 0.3;
            z-index: 0;
        }
        
        .education-plan::after {
            content: '';
            position: absolute;
            top: 100px;
            right: -80px;
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, #ffd3a5 0%, #fd9853 100%);
            border-radius: 50%;
            opacity: 0.2;
            z-index: 0;
        }
        
        .decoration-circle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.15;
            z-index: 0;
        }
        
        .decoration-circle-1 {
            top: 60%;
            left: -30px;
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }
        
        .decoration-circle-2 {
            bottom: -40px;
            right: 200px;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        
        .plan-content {
            position: relative;
            z-index: 1;
        }
        
        .plan-title {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .plan-title h1 {
            font-size: 2.5em;
            color: #2d5a27;
            font-weight: 900;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .plan-title .highlight {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            color: #2d5a27;
            font-weight: 700;
        }
        
        .plan-title h2 {
            font-size: 2.2em;
            color: #27ae60;
            font-weight: 800;
            margin-top: 15px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            background: linear-gradient(135deg, #ff8c00 0%, #ff6b35 100%);
            color: white;
            padding: 8px 18px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 400;
            margin-bottom: 18px;
            box-shadow: 0 2px 6px rgba(255, 140, 0, 0.18);
        }
        
        .basic-info {
            display: grid;
            gap: 15px;
        }
        
        .info-row {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-height: 60px;
        }
        
        .info-label {
            background: #27ae60;
            color: white;
            padding: 20px 25px;
            font-weight: 600;
            min-width: 120px;
            text-align: center;
            border-radius: 15px 0 0 15px;
        }
        
        .info-content {
            padding: 20px 25px;
            flex: 1;
            font-weight: 500;
            color: #2c3e50;
            font-size: 1.3em;
        }
        
        .info-content[contenteditable="true"]:focus {
            outline: 2px solid #27ae60;
            background: #f8fff8;
            border-radius: 0 15px 15px 0;
        }
        
        .program-grid {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        /* í”„ë¡œê·¸ë¨ í…Œì´ë¸” ë™ì  ì»¬ëŸ¼ ë„ˆë¹„ ìŠ¤íƒ€ì¼ */
        .program-grid.table-3cols .program-header,
        .program-grid.table-3cols .program-row {
            grid-template-columns: 2fr 1fr 1fr;
        }

        .program-grid.table-4cols .program-header,
        .program-grid.table-4cols .program-row {
            grid-template-columns: 2fr 1fr 1fr 1fr;
        }

        .program-grid.table-5cols .program-header,
        .program-grid.table-5cols .program-row {
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
        }

        .program-header {
            background: #27ae60;
            color: white;
            display: grid;
            gap: 1px;
        }
        
        .program-header div {
            padding: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .program-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1px;
            background: #27ae60;
        }
        
        .program-cell {
            background: white;
            padding: 18px 20px;
            text-align: center;
            font-weight: 500;
            color: #2c3e50;
            transition: all 0.3s ease;
            font-size: 1.22em;
        }
        
        .program-cell:hover {
            background: #f8fff8;
        }
        
        .program-cell[contenteditable="true"]:focus {
            outline: 2px solid #27ae60;
            background: #f8fff8;
        }
        
        .program-row:nth-child(even) .program-cell {
            background: #f8f9fa;
        }
        
        .program-row:nth-child(even) .program-cell:hover,
        .program-row:nth-child(even) .program-cell[contenteditable="true"]:focus {
            background: #f8fff8;
        }
        
        .schedule-grid {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .schedule-header {
            background: #27ae60;
            color: white;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1px;
        }
        
        .schedule-header div {
            padding: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .schedule-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1px;
            background: #27ae60;
        }
        
        .schedule-cell {
            background: white;
            padding: 18px 20px;
            font-weight: 500;
            color: #2c3e50;
            transition: all 0.3s ease;
            font-size: 1.22em;
        }
        
        .schedule-cell:first-child {
            text-align: center;
            font-weight: 600;
            background: #f8f9fa;
        }
        
        .schedule-cell:hover {
            background: #f8fff8;
        }
        
        .schedule-cell[contenteditable="true"]:focus {
            outline: 2px solid #27ae60;
            background: #f8fff8;
        }
        
        .schedule-row:nth-child(even) .schedule-cell {
            background: #f8f9fa;
        }
        
        .schedule-row:nth-child(even) .schedule-cell:first-child {
            background: #e9ecef;
        }
        
        .schedule-row:nth-child(even) .schedule-cell:hover,
        .schedule-row:nth-child(even) .schedule-cell[contenteditable="true"]:focus {
            background: #f8fff8;
        }
        
        .note-box {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 5px solid #ffc107;
            padding: 20px 25px;
            border-radius: 0 15px 15px 0;
            margin: 25px 0;
            color: #856404;
            font-weight: 500;
            position: relative;
        }
        
        .note-box::before {
            content: 'ğŸ’¡';
            font-size: 1.2em;
            margin-right: 10px;
        }
        
        .download-section {
            text-align: center;
            padding: 30px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%);
            color: white;
            margin: 0 8px;
            min-width: 150px;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(253, 126, 20, 0.3);
        }
        
        .save-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #007bff 100%);
            color: white;
            margin: 0 8px;
            min-width: 150px;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.3);
        }
        
        .tab-container {
            margin-bottom: 25px;
        }
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #e9ecef;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .contact-form,
        .contact-list {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .contact-list { margin-top: 20px; }
        .contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.95em;
        }
        .contact-item:last-child { border-bottom: none; }
        .delete-btn {
            background: #dc3545;
            color: #fff;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d1edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        .date-select {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .date-option {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .date-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .date-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .month-select {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .month-option {
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #495057;
        }

        .month-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .month-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .data-status {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #17a2b8;
            font-size: 0.9em;
        }

        .data-status.loading {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .data-status.success {
            border-left-color: #28a745;
            background: #d1edda;
        }

        .data-status.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .location-radio {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .location-radio label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            color: #495057;
        }

        @media print {
            .download-section, .save-btn { display: none !important; }
            .education-plan::before, .education-plan::after, .decoration-circle { display: none !important; }
            .education-plan {
                box-shadow: none !important;
                border: 1px solid #ddd;
            }
        }

        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { border-radius: 10px; }
            .header { padding: 30px 20px; }
            .logo { font-size: 2.2em; letter-spacing: 2px; }
            .subtitle { font-size: 1.2em; }
            .form-section { padding: 25px 20px; }
            .button-group { flex-direction: column; }
            .generate-btn, .refresh-btn { min-width: auto; width: 100%; }
            .plan-result { padding: 20px 15px; }
            .education-plan { padding: 25px 20px; }
            .plan-title h1 { font-size: 2em; }
            .plan-title h2 { font-size: 1.8em; }
            .info-label { min-width: 100px; padding: 15px 20px; font-size: 0.9em; }
            .program-header, .program-row { grid-template-columns: 2fr 1fr 1fr; }
            .schedule-header, .schedule-row { grid-template-columns: 1fr 2fr; }
        }

        .program-cell, .schedule-cell {
            font-size: 1.22em;
        }

        /* ëŒ€ê¸°ì—… ìŠ¤íƒ€ì¼ í—¤ë” */
        .plan-title.corporate {
            text-align: center;
            margin-bottom: 40px;
            padding-top: 30px;
            padding-bottom: 30px;
            background: linear-gradient(90deg, #e9ecef 0%, #f8f9fa 100%);
            border-radius: 0 0 32px 32px;
            box-shadow: 0 8px 32px rgba(44,62,80,0.08);
            position: relative;
        }
        .plan-title.corporate .brand-row {
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 18px;
            margin-bottom: 18px;
        }
        .dreamflex-logo {
            font-family: -apple-system, 'SF Pro Display', 'SF Pro', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            font-size: 2.6em;
            font-weight: 900;
            letter-spacing: 0.12em;
            color: #1a2a3a;
            text-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .slogan {
            font-family: -apple-system, 'SF Pro Display', 'SF Pro', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            font-size: 1.2em;
            font-weight: 600;
            color: #f5b800;
            background: none;
            letter-spacing: 0.08em;
        }
        .main-title {
            font-family: -apple-system, 'SF Pro Display', 'SF Pro', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            font-size: 2.8em;
            font-weight: 900;
            color: #1769aa;
            letter-spacing: 0.04em;
            margin-top: 10px;
            margin-bottom: 0;
            text-shadow: 0 2px 8px rgba(23,105,170,0.08);
            border-bottom: 2px solid #f5b800;
            display: inline-block;
            padding-bottom: 8px;
        }

        /* íŠ¸ë Œë”” ìŠ¤íƒ€ì¼ í—¤ë” */
        .plan-title.trendy {
            text-align: center;
            margin-bottom: 60px;
            padding: 40px 0;
            border-bottom: 1px solid #eee;
        }
        .plan-title.trendy .brand-mark {
            display: inline-block;
            font-size: 1.2em;
            font-weight: 600;
            letter-spacing: 2px;
            color: #fff;
            background: linear-gradient(135deg, #6e8efb 0%, #a777e3 100%);
            padding: 8px 18px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-transform: uppercase;
        }
        .plan-title.trendy h1 {
            font-family: -apple-system, 'SF Pro Display', 'SF Pro', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            font-size: 3.5em;
            font-weight: 900;
            color: #2c3e50;
            margin: 0 0 10px 0;
        }
        .plan-title.trendy h2 {
            font-family: -apple-system, 'SF Pro Display', 'SF Pro', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            font-size: 2em;
            font-weight: 300;
            color: #7f8c8d;
            margin: 0;
            letter-spacing: 4px;
        }

        /* êµí†µë¹„ ê³„ì‚° ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .transport-tab {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .route-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }

        .cost-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .cost-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .cost-item .amount {
            font-size: 1.5em;
            font-weight: bold;
            color: #2196f3;
        }

        .carpool-info {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #ff9800;
        }

        .carpool-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .carpool-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid #ff9800;
        }

        .carpool-card .passengers {
            font-size: 1.2em;
            font-weight: bold;
            color: #ff9800;
        }

        .carpool-card .cost {
            font-size: 1.1em;
            color: #333;
            margin-top: 5px;
        }

        .kakao-share-btn {
            background: linear-gradient(135deg, #fee500 0%, #ffd700 100%);
            color: #3c1e1e;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        .kakao-share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(254, 229, 0, 0.4);
        }

        .fuel-settings {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .fuel-settings input {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 0 10px;
        }

        .route-details {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #e9ecef;
        }

        .route-details .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .route-details .detail-item:last-child {
            border-bottom: none;
        }

        .loading-route {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading-route .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @media (max-width: 768px) {
            .cost-breakdown {
                grid-template-columns: 1fr;
            }
            .carpool-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="logo">DREAMPLEX</div>
                <div class="subtitle">ë“œë¦¼í”Œë ‰ìŠ¤ êµìœ¡ê³„íšì„œ ìƒì„±ê¸°</div>
                <div class="header-badge">AI ê¸°ë°˜ êµìœ¡ ì†”ë£¨ì…˜</div>
            </div>
        </div>
        
        <div class="form-section">
            <div id="dataStatus" class="data-status" style="display: none;">
                <div id="statusMessage">ì¤€ë¹„ ì¤‘...</div>
            </div>

            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('plan')">ê³„íšì„œ ìƒì„±</button>
                    <button class="tab-button" onclick="switchTab('contact')">ë‹´ë‹¹ì ë“±ë¡</button>
                    <button class="tab-button" onclick="switchTab('transport')">êµí†µë¹„ ê³„ì‚°</button>
                </div>

                <div id="planTab" class="tab-content active">
                    <div class="form-group">
                        <label>ğŸ“… ì›” ì„ íƒ</label>
                        <div id="monthOptions" class="month-select"></div>
                    </div>

                    <div class="form-group">
                        <label for="schoolSelect">ğŸ« í•™êµ ì„ íƒ</label>
                        <select id="schoolSelect" class="school-select" disabled>
                            <option value="">ë¨¼ì € ì›”ì„ ì„ íƒí•˜ì„¸ìš”...</option>
                        </select>
                    </div>
                    
                    <div id="dateSelectionContainer" class="form-group" style="display: none;">
                        <label>ğŸ“… êµìœ¡ ë‚ ì§œ ì„ íƒ</label>
                        <div id="dateOptions" class="date-select"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactSelect">ğŸ‘¤ ë‹´ë‹¹ì ì„ íƒ</label>
                        <select id="contactSelect" class="school-select">
                            <option value="">ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ğŸ“ ìœ„ì¹˜ ë°°ì • ë°©ì‹</label>
                        <div class="location-radio">
                            <label><input type="radio" name="locationAssignment" value="pre" checked> ì‚¬ì „ ë°°ì •</label>
                            <label><input type="radio" name="locationAssignment" value="onsite"> í˜„ì¥ ë°°ì •</label>
                        </div>
                    </div>
                </div>

                <div id="contactTab" class="tab-content">
                    <div class="contact-form">
                        <div class="form-group">
                            <label for="contactPosition">ì§ì±…</label>
                            <input type="text" id="contactPosition" class="school-select" placeholder="ì˜ˆ: êµì‚¬">
                        </div>
                        <div class="form-group">
                            <label for="contactName">ì´ë¦„</label>
                            <input type="text" id="contactName" class="school-select" placeholder="ì˜ˆ: í™ê¸¸ë™">
                        </div>
                        <div class="form-group">
                            <label for="contactPhone">ì „í™”ë²ˆí˜¸</label>
                            <input type="tel" id="contactPhone" class="school-select" placeholder="ì˜ˆ: 010-1234-5678">
                        </div>
                        <button onclick="addContact()" class="generate-btn">ë“±ë¡</button>
                    </div>
                    <div id="contactList" class="contact-list"></div>
                </div>

                <div id="transportTab" class="tab-content">
                    <div class="transport-tab">
                        <h3>ğŸš— êµí†µë¹„ ê³„ì‚°</h3>
                        
                        <div class="fuel-settings">
                            <label>â›½ ì—°ë¹„ ì„¤ì • (km/L): <input type="number" id="fuelEfficiency" value="12" min="1" max="50"></label>
                            <label>ğŸ’° ìœ ë¥˜ë¹„ (ì›/L): <input type="number" id="fuelPrice" value="1700" min="1000" max="3000"></label>
                        </div>

                        <div id="routeCalculation" style="display: none;">
                            <div class="route-info">
                                <h4>ğŸ“ ê²½ë¡œ ì •ë³´</h4>
                                <div id="routeDetails" class="route-details">
                                    <div class="detail-item">
                                        <span>ì¶œë°œì§€:</span>
                                        <span>ëŒ€êµ¬ê´‘ì—­ì‹œ</span>
                                    </div>
                                    <div class="detail-item">
                                        <span>ëª©ì ì§€:</span>
                                        <span id="destinationSchool"></span>
                                    </div>
                                    <div class="detail-item">
                                        <span>ì´ ê±°ë¦¬:</span>
                                        <span id="totalDistance"></span>
                                    </div>
                                    <div class="detail-item">
                                        <span>ì˜ˆìƒ ì†Œìš”ì‹œê°„:</span>
                                        <span id="estimatedTime"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="cost-breakdown">
                                <div class="cost-item">
                                    <div>â›½ ì™•ë³µ ì—°ë£Œë¹„</div>
                                    <div class="amount" id="fuelCost">-</div>
                                </div>
                                <div class="cost-item">
                                    <div>ğŸ›£ï¸ ì™•ë³µ í†µí–‰ë£Œ</div>
                                    <div class="amount" id="tollCost">-</div>
                                </div>
                                <div class="cost-item">
                                    <div>ğŸ’° ì´ êµí†µë¹„</div>
                                    <div class="amount" id="totalCost">-</div>
                                </div>
                            </div>

                            <div class="carpool-info">
                                <h4>ğŸ‘¥ ì¹´í’€ë¹„ ì•ˆë‚´</h4>
                                <div class="carpool-cards">
                                    <div class="carpool-card">
                                        <div class="passengers">2ëª…</div>
                                        <div class="cost" id="carpool2">-</div>
                                    </div>
                                    <div class="carpool-card">
                                        <div class="passengers">3ëª…</div>
                                        <div class="cost" id="carpool3">-</div>
                                    </div>
                                    <div class="carpool-card">
                                        <div class="passengers">4ëª…</div>
                                        <div class="cost" id="carpool4">-</div>
                                    </div>
                                </div>
                                
                                <button class="kakao-share-btn" onclick="copyKakaoText()">
                                    ğŸ“‹ ì¹´í†¡ìš© í…ìŠ¤íŠ¸ ë³µì‚¬
                                </button>
                            </div>
                        </div>

                        <div id="loadingRoute" class="loading-route" style="display: none;">
                            <div class="spinner"></div>
                            <p>ê²½ë¡œë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        </div>

                        <div id="noRouteData" style="text-align: center; padding: 40px; color: #666;">
                            <p>ğŸ“‹ ë¨¼ì € êµìœ¡ê³„íšì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.</p>
                            <p>ê³„íšì„œ ìƒì„± í›„ ìë™ìœ¼ë¡œ êµí†µë¹„ê°€ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
                            <br>
                            <button class="kakao-share-btn" onclick="showGoogleAppsScriptGuide()" style="background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);">
                                ğŸ”§ Google Apps Script ì„¤ì • ê°€ì´ë“œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <label style="display:inline-block;">
                    <input type="file" id="csvUpload" accept=".csv" style="display:none;" onchange="handleCSVUpload(event)">
                    <button type="button" class="refresh-btn" style="background:linear-gradient(135deg,#fd7e14 0%,#20c997 100%);color:white;" onclick="document.getElementById('csvUpload').click();">ğŸ“ CSV ì—…ë¡œë“œ</button>
                </label>
                <button onclick="generatePlan()" id="generateBtn" class="generate-btn" disabled>
                    ğŸ“‹ ê³„íšì„œ ìƒì„±í•˜ê¸°
                </button>
            </div>
        </div>
        
        <div id="loading" class="loading" style="display:none;">
            <div class="spinner"></div>
            <p>êµìœ¡ê³„íšì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>
        
        <div id="planResult" class="plan-result"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script>
        var schoolData = [];
        var dataByMonth = {};
        var contacts = [];
        var selectedMonth = null;
        var selectedDate = null;
        var isDataLoaded = false;
        var planData = null;

        function updateStatus(type, message) {
            var statusDiv = document.getElementById('dataStatus');
            var statusMessage = document.getElementById('statusMessage');
            statusDiv.style.display = 'block';
            statusDiv.className = 'data-status ' + type;
            statusMessage.textContent = message;
        }

        function extractMonth(dateString) {
            if (!dateString) return null;
            var match = dateString.match(/25\.(\d{2})\./);
            if (match) {
                var month = parseInt(match[1]);
                return '2025-' + (month < 10 ? '0' + month : month);
            }
            return null;
        }

        function groupDataByMonth(data) {
            var grouped = {};
            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var month = extractMonth(item['ì²´í—˜ì¼']);
                if (month) {
                    if (!grouped[month]) {
                        grouped[month] = [];
                    }
                    grouped[month].push(item);
                }
            }
            return grouped;
        }

        function handleCSVUpload(event) {
            var file = event.target.files[0];
            if (!file) {
                updateStatus('error', 'âŒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!file.name.endsWith('.csv')) {
                updateStatus('error', 'âŒ CSV íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                event.target.value = '';
                return;
            }
            updateStatus('loading', 'ğŸ”„ CSV íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘...');
            var reader = new FileReader();
            reader.onload = function(e) {
                Papa.parse(e.target.result, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: 'UTF-8',
                    complete: function(results) {
                        try {
                            var data = results.data;
                            if (!data || data.length === 0) {
                                throw new Error('CSV íŒŒì¼ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
                            }
                            var requiredHeaders = ['ì²´í—˜ì¼', 'í•™êµ', 'ìˆ˜ì—…', 'ìˆ˜ì—…ì‹œê°„', 'ì°¨ì‹œ'];
                            var headers = Object.keys(data[0] || {});
                            var missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                            if (missingHeaders.length > 0) {
                                throw new Error('í•„ìˆ˜ ì—´ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ' + missingHeaders.join(', '));
                            }
                            schoolData = data.map(row => {
                                var rowObj = {};
                                headers.forEach(h => {
                                    rowObj[h] = row[h] !== null && row[h] !== undefined ? row[h].toString() : '';
                                });
                                return rowObj;
                            }).filter(row => row['ì²´í—˜ì¼'] && row['í•™êµ'] && row['ìˆ˜ì—…ì‹œê°„'] && row['ì°¨ì‹œ']);
                            if (schoolData.length === 0) {
                                throw new Error('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                            }
                            dataByMonth = groupDataByMonth(schoolData);
                            isDataLoaded = true;
                            var monthCount = Object.keys(dataByMonth).length;
                            updateStatus('success', 'âœ… ì„±ê³µ! ' + schoolData.length + 'ê°œì˜ êµìœ¡ ì¼ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (' + monthCount + 'ê°œì›”, ìµœì¢… ì—…ë°ì´íŠ¸: ' + new Date().toLocaleString() + ')');
                            updateMonthOptions();
                            event.target.value = '';
                        } catch (error) {
                            console.error('CSV ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                            updateStatus('error', 'âŒ CSV ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                            event.target.value = '';
                        }
                    },
                    error: function(error) {
                        console.error('CSV íŒŒì‹± ì˜¤ë¥˜:', error);
                        updateStatus('error', 'âŒ CSV íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                        event.target.value = '';
                    }
                });
            };
            reader.readAsText(file);
        }

        function updateMonthOptions() {
            var monthContainer = document.getElementById('monthOptions');
            monthContainer.innerHTML = '';
            var availableMonths = Object.keys(dataByMonth).sort();
            if (availableMonths.length === 0) {
                monthContainer.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">ì‚¬ìš© ê°€ëŠ¥í•œ ì›”ì´ ì—†ìŠµë‹ˆë‹¤. CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</div>';
                return;
            }
            var monthNames = {
                '2025-06': '2025ë…„ 6ì›”',
                '2025-07': '2025ë…„ 7ì›”',
                '2025-08': '2025ë…„ 8ì›”',
                '2025-09': '2025ë…„ 9ì›”',
                '2025-10': '2025ë…„ 10ì›”',
                '2025-11': '2025ë…„ 11ì›”',
                '2025-12': '2025ë…„ 12ì›”'
            };
            for (var i = 0; i < availableMonths.length; i++) {
                var month = availableMonths[i];
                var monthDiv = document.createElement('div');
                monthDiv.className = 'month-option';
                monthDiv.setAttribute('data-month', month);
                monthDiv.onclick = function() { selectMonth(this.getAttribute('data-month'), this); };
                var schools = {};
                for (var j = 0; j < dataByMonth[month].length; j++) {
                    schools[dataByMonth[month][j]['í•™êµ']] = true;
                }
                var schoolCount = Object.keys(schools).length;
                monthDiv.innerHTML = (monthNames[month] || month) + '<br><small style="opacity: 0.8;">' + schoolCount + 'ê°œ í•™êµ</small>';
                monthContainer.appendChild(monthDiv);
            }
        }

        function selectMonth(month, element) {
            var monthOptions = document.querySelectorAll('.month-option');
            for (var i = 0; i < monthOptions.length; i++) {
                monthOptions[i].classList.remove('selected');
            }
            element.classList.add('selected');
            selectedMonth = month;
            updateSchoolSelect();
            resetDateSelection();
            checkGenerateBtn();
        }

        function updateSchoolSelect() {
            var schoolSelect = document.getElementById('schoolSelect');
            if (!selectedMonth || !dataByMonth[selectedMonth]) {
                schoolSelect.innerHTML = '<option value="">ë¨¼ì € ì›”ì„ ì„ íƒí•˜ì„¸ìš”...</option>';
                schoolSelect.disabled = true;
                return;
            }
            var monthData = dataByMonth[selectedMonth];
            var schools = {};
            for (var i = 0; i < monthData.length; i++) {
                var school = monthData[i]['í•™êµ'];
                if (school) {
                    schools[school] = schools[school] || [];
                    schools[school].push(monthData[i]['ì²´í—˜ì¼']);
                }
            }
            var uniqueSchools = Object.keys(schools).sort((a, b) => {
                var latestDateA = Math.max(...schools[a].map(date => new Date(date.replace(/\./g, '-')).getTime()));
                var latestDateB = Math.max(...schools[b].map(date => new Date(date.replace(/\./g, '-')).getTime()));
                return latestDateB - latestDateA;
            });
            schoolSelect.disabled = false;
            schoolSelect.innerHTML = '<option value="">í•™êµë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>';
            for (var i = 0; i < uniqueSchools.length; i++) {
                var school = uniqueSchools[i];
                var uniqueDates = [...new Set(schools[school])].sort((a, b) => new Date(b.replace(/\./g, '-')).getTime() - new Date(a.replace(/\./g, '-')).getTime()).join(', ');
                var option = document.createElement('option');
                option.value = school;
                option.textContent = school + ' (' + uniqueDates + ')';
                schoolSelect.appendChild(option);
            }
        }

        function onSchoolSelect() {
            var selectedSchool = document.getElementById('schoolSelect').value;
            var dateContainer = document.getElementById('dateSelectionContainer');
            var dateOptions = document.getElementById('dateOptions');
            if (selectedSchool && selectedMonth) {
                var schoolSchedules = dataByMonth[selectedMonth].filter(function(item) {
                    return item['í•™êµ'] === selectedSchool;
                });
                var dates = {};
                for (var i = 0; i < schoolSchedules.length; i++) {
                    var date = schoolSchedules[i]['ì²´í—˜ì¼'];
                    if (date) {
                        dates[date] = true;
                    }
                }
                var uniqueDates = Object.keys(dates).sort().reverse();
                if (uniqueDates.length > 0) {
                    dateOptions.innerHTML = '';
                    for (var i = 0; i < uniqueDates.length; i++) {
                        var date = uniqueDates[i];
                        var dateDiv = document.createElement('div');
                        dateDiv.className = 'date-option';
                        dateDiv.setAttribute('data-date', date);
                        dateDiv.onclick = function() { selectDate(this.getAttribute('data-date'), this); };
                        var programCount = schoolSchedules.filter(function(item) {
                            return item['ì²´í—˜ì¼'] === date;
                        }).length;
                        dateDiv.innerHTML = date + '<br><small style="opacity: 0.8;">' + programCount + 'ê°œ í”„ë¡œê·¸ë¨</small>';
                        dateOptions.appendChild(dateDiv);
                    }
                    dateContainer.style.display = 'block';
                } else {
                    dateContainer.style.display = 'none';
                }
            } else {
                dateContainer.style.display = 'none';
            }
            selectedDate = null;
            checkGenerateBtn();
        }

        function resetDateSelection() {
            document.getElementById('dateSelectionContainer').style.display = 'none';
            selectedDate = null;
        }

        function selectDate(date, element) {
            var dateOptions = document.querySelectorAll('.date-option');
            for (var i = 0; i < dateOptions.length; i++) {
                dateOptions[i].classList.remove('selected');
            }
            element.classList.add('selected');
            selectedDate = date;
            checkGenerateBtn();
        }

        function checkGenerateBtn() {
            var school = document.getElementById('schoolSelect').value;
            var contact = document.getElementById('contactSelect').value;
            var canGenerate = school && selectedMonth && selectedDate && contact && isDataLoaded;
            document.getElementById('generateBtn').disabled = !canGenerate;
        }

        document.getElementById('schoolSelect').addEventListener('change', onSchoolSelect);
        document.getElementById('contactSelect').addEventListener('change', checkGenerateBtn);

        function switchTab(tabName) {
            var tabs = document.querySelectorAll('.tab-content');
            var buttons = document.querySelectorAll('.tab-button');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector('.tab-button[onclick="switchTab(\'' + tabName + '\')"]').classList.add('active');
        }

        function addContact() {
            var position = document.getElementById('contactPosition').value.trim();
            var name = document.getElementById('contactName').value.trim();
            var phone = document.getElementById('contactPhone').value.trim();
            if (!position || !name || !phone) {
                alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            var info = position + ' ' + name + ' (' + phone + ')';
            contacts.push({ position: position, name: name, phone: phone, info: info });
            updateContactList();
            updateContactSelect();
            clearContactForm();
            alert('ë‹´ë‹¹ìê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function updateContactList() {
            var list = document.getElementById('contactList');
            if (contacts.length === 0) {
                list.innerHTML = '<p style="color:#666;">ë“±ë¡ëœ ë‹´ë‹¹ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            var html = '';
            for (var i = 0; i < contacts.length; i++) {
                var c = contacts[i];
                html += '<div class="contact-item">' +
                       '<span>' + c.info + '</span>' +
                       '<button class="delete-btn" onclick="deleteContact(' + i + ')">ì‚­ì œ</button>' +
                       '</div>';
            }
            list.innerHTML = html;
        }

        function updateContactSelect() {
            var select = document.getElementById('contactSelect');
            var html = '<option value="">ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>';
            for (var i = 0; i < contacts.length; i++) {
                var c = contacts[i];
                html += '<option value="' + c.info + '">' + c.info + '</option>';
            }
            select.innerHTML = html;
            checkGenerateBtn();
        }

        function deleteContact(idx) {
            if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                contacts.splice(idx, 1);
                updateContactList();
                updateContactSelect();
            }
        }

        function clearContactForm() {
            document.getElementById('contactPosition').value = '';
            document.getElementById('contactName').value = '';
            document.getElementById('contactPhone').value = '';
        }

        function generatePlan() {
            var schoolName = document.getElementById('schoolSelect').value;
            var contactInfo = document.getElementById('contactSelect').value;
            var locationAssignment = document.querySelector('input[name="locationAssignment"]:checked').value;
            if (!schoolName || !selectedMonth || !selectedDate || !contactInfo) {
                alert('ëª¨ë“  ì •ë³´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            document.getElementById('loading').style.display = 'block';
            document.getElementById('planResult').innerHTML = '';
            setTimeout(() => {
                displayPlan(schoolName, selectedDate, contactInfo, locationAssignment);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('planResult').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 2000);
        }

        function displayPlan(schoolName, selectedDate, contactInfo, locationAssignment) {
            var resultDiv = document.getElementById('planResult');
            var schoolSchedules = dataByMonth[selectedMonth].filter(function(item) {
                return item['ì²´í—˜ì¼'] === selectedDate && item['í•™êµ'] === schoolName;
            });
            if (schoolSchedules.length === 0) {
                resultDiv.innerHTML = '<div class="error-message">' +
                    'ì„ íƒëœ ë‚ ì§œ(' + selectedDate + ')ì™€ í•™êµ(' + schoolName + ')ì— ëŒ€í•œ êµìœ¡ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' +
                    '</div>';
                return;
            }
            var timeRange = schoolSchedules[0]['ìˆ˜ì—…ì‹œê°„'] || '09:00 ~ 12:30';
            var totalClasses = parseInt(schoolSchedules[0]['ì°¨ì‹œ']) || 4;
            var schoolType = schoolName.includes('ê³ ë“±í•™êµ') ? 'high' : 
                            schoolName.includes('ì¤‘í•™êµ') ? 'middle' : 'elementary';
            var lessonDuration = (schoolType === 'high') ? 50 : 
                               (schoolType === 'middle') ? 45 : 40; // ê³ ë“±í•™êµ 50ë¶„, ì¤‘í•™êµ 45ë¶„, ì´ˆë“±í•™êµ 40ë¶„

            var programs = [];
            for (var i = 0; i < schoolSchedules.length; i++) {
                var item = schoolSchedules[i];
                var location = locationAssignment === 'pre' ? (item['í•™ë…„'] || 'ì „ì²´') : 'í˜„ì¥ ë°°ì •';
                
                // í•™ë…„ í‘œì‹œ ì²˜ë¦¬
                if (location !== 'í˜„ì¥ ë°°ì •' && location !== 'ì „ì²´') {
                    if (/^\d+$/.test(location)) {
                        location = location + 'í•™ë…„';
                    } else if (!location.includes('í•™ë…„')) {
                        location = location + 'í•™ë…„';
                    }
                }
                
                programs.push({
                    name: item['ìˆ˜ì—…'] || 'ë¯¸ì •',
                    instructor: item['ê°•ì‚¬ì´ë¦„'] || 'ë¯¸ì •',
                    location: location
                });
            }

            var schedule = generateScheduleFromTime(timeRange, totalClasses, schoolType);
            planData = {
                school: {
                    name: schoolName,
                    date: selectedDate,
                    location: schoolSchedules[0]['ì§€ì—­'] || 'ìœ„ì¹˜ ë¯¸ì •',
                    totalClasses: schoolSchedules[0]['ì°¨ì‹œ'] || 'ë¯¸ì •',
                    time: timeRange,
                    contact: contactInfo
                },
                programs: programs,
                schedule: schedule,
                locationAssignment: locationAssignment,
                schoolSchedules: schoolSchedules // schoolSchedulesë¥¼ planDataì— ì¶”ê°€
            };
            renderPlan();
            
            // êµí†µë¹„ ê³„ì‚° ìë™ ì‹¤í–‰
            setTimeout(() => {
                calculateTransportCost();
            }, 1000);
        }

        function renderPlan() {
            var resultDiv = document.getElementById('planResult');
            var schoolNameWithLocation = planData.school.name;
            if (planData.school.location && planData.school.location !== 'ìœ„ì¹˜ ë¯¸ì •') {
                schoolNameWithLocation += ' (' + planData.school.location + ')';
            }
            // ëŒ€ìƒ í•™ë…„ ì¶”ì¶œ ë° ì¤‘ë³µ ë°©ì§€
            var grade = '';
            var classCount = '';
            var studentCount = '';
            
            if (planData.programs && planData.programs.length > 0) {
                var firstLocation = planData.programs[0].location;
                // ìˆ«ìë§Œ ìˆìœ¼ë©´ í•™ë…„ ë¶™ì´ê¸°, ì´ë¯¸ í•™ë…„ í¬í•¨ì´ë©´ ê·¸ëŒ€ë¡œ
                if (/^\d+$/.test(firstLocation)) {
                    grade = firstLocation + 'í•™ë…„';
                } else if (firstLocation.includes('í•™ë…„')) {
                    grade = firstLocation.replace(/(í•™ë…„)+/, 'í•™ë…„');
                } else {
                    grade = firstLocation;
                }

                // ë°˜ì¸ì›ìˆ˜ ì •ë³´ ì²˜ë¦¬
                var studentCounts = planData.schoolSchedules
                    .map(item => item['ë°˜ì¸ì›ìˆ˜'])
                    .filter(count => count && !isNaN(parseInt(count)))
                    .map(count => parseInt(count));

                if (studentCounts.length > 0) {
                    var avgCount = Math.round(studentCounts.reduce((a, b) => a + b, 0) / studentCounts.length);
                    studentCount = ' (ì•½ ë°˜ë‹¹ ' + avgCount + 'ëª…)';
                }
            } else {
                grade = 'í•™ë…„';
            }
            var html = '<div class="education-plan">' +
                '<div class="decoration-circle decoration-circle-1"></div>' +
                '<div class="decoration-circle decoration-circle-2"></div>' +
                '<div class="plan-content">' +
                '<div class="plan-title trendy">' +
                '    <span class="brand-mark">DREAMPLEX</span>' +
                '    <h1>' + planData.school.name + '</h1>' +
                '    <h2>êµìœ¡ê³„íšì„œ</h2>' +
                '</div>' +
                
                '<div class="section">' +
                '<div class="section-title">ê¸°ë³¸ì‚¬í•­</div>' +
                '<div class="basic-info">' +
                '<div class="info-row">' +
                '<div class="info-label">ì¥ì†Œ</div>' +
                '<div class="info-content" contenteditable="true">' + schoolNameWithLocation + '</div>' +
                '</div>' +
                '<div class="info-row">' +
                '<div class="info-label">ì¼ì‹œ</div>' +
                '<div class="info-content" contenteditable="true">' + planData.school.date + '</div>' +
                '</div>' +
                '<div class="info-row">' +
                '<div class="info-label">ëŒ€ìƒ</div>' +
                '<div class="info-content" contenteditable="true">' + grade + studentCount + '</div>' +
                '</div>' +
                '<div class="info-row">' +
                '<div class="info-label">ì‹œê°„</div>' +
                '<div class="info-content" contenteditable="true">' + planData.school.time + '</div>' +
                '</div>' +
                '<div class="info-row">' +
                '<div class="info-label">ìœ„ì¹˜</div>' +
                '<div class="info-content" contenteditable="true">ë³¸ê´€ í˜„ê´€ (ë¯¸ë¦¬ ë„ì°©í•œ ê²½ìš° ì°¨ì—ì„œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.)</div>' +
                '</div>' +
                '<div class="info-row">' +
                '<div class="info-label">ë‹´ë‹¹ì</div>' +
                '<div class="info-content" contenteditable="true">' + planData.school.contact + '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                
                '<div class="section">' +
                '<div class="section-title">í”„ë¡œê·¸ë¨</div>' +
                '<div class="program-grid">';

            // AIêµìœ¡ ì—¬ë¶€ í™•ì¸
            var isAIEducation = planData.programs.some(program => 
                program.name.includes('AIë¯¸ë˜í•™êµ') || 
                program.name.includes('AIê¸°ì—…ê°€ì •ì‹ ') || 
                program.name.includes('ê¸°ì—…ê°€ì •ì‹ ')
            );

            // ì°¨ì‹œ ìˆ˜ í™•ì¸
            var totalClasses = parseInt(planData.school.totalClasses) || 4;

            // í…Œì´ë¸” í´ë˜ìŠ¤ ì„¤ì •
            if (isAIEducation || totalClasses === 2) {
                html = html.replace('class="program-grid">', 'class="program-grid table-3cols">');
            } else if (totalClasses === 4) {
                html = html.replace('class="program-grid">', 'class="program-grid table-4cols">');
            } else if (totalClasses === 6) {
                html = html.replace('class="program-grid">', 'class="program-grid table-5cols">');
            }

            // í…Œì´ë¸” í—¤ë” ìƒì„±
            if (isAIEducation || totalClasses === 2) {
                // AIêµìœ¡ ë˜ëŠ” 2ì°¨ì‹œ: 3ì¹¸ í…Œì´ë¸”
                html += '<div class="program-header">' +
                    '<div>í”„ë¡œê·¸ë¨</div>' +
                    '<div>ê°•ì‚¬</div>' +
                    '<div>ìœ„ì¹˜</div>' +
                    '</div>';
            } else if (totalClasses === 4) {
                // 4ì°¨ì‹œ: 4ì¹¸ í…Œì´ë¸”
                html += '<div class="program-header">' +
                    '<div>í”„ë¡œê·¸ë¨</div>' +
                    '<div>ê°•ì‚¬</div>' +
                    '<div>1-2ì°¨ì‹œ</div>' +
                    '<div>3-4ì°¨ì‹œ</div>' +
                    '</div>';
            } else if (totalClasses === 6) {
                // 6ì°¨ì‹œ: 5ì¹¸ í…Œì´ë¸”
                html += '<div class="program-header">' +
                    '<div>í”„ë¡œê·¸ë¨</div>' +
                    '<div>ê°•ì‚¬</div>' +
                    '<div>1-2ì°¨ì‹œ</div>' +
                    '<div>3-4ì°¨ì‹œ</div>' +
                    '<div>5-6ì°¨ì‹œ</div>' +
                    '</div>';
            }

            // í”„ë¡œê·¸ë¨ í–‰ ìƒì„±
            for (var i = 0; i < planData.programs.length; i++) {
                var program = planData.programs[i];
                html += '<div class="program-row">' +
                    '<div class="program-cell" contenteditable="true">' + program.name + '</div>' +
                    '<div class="program-cell" contenteditable="true">' + program.instructor + '</div>';

                if (isAIEducation || totalClasses === 2) {
                    // AIêµìœ¡ ë˜ëŠ” 2ì°¨ì‹œ: 1-2ì°¨ì‹œ ìœ„ì¹˜ë§Œ í‘œì‹œ
                    html += '<div class="program-cell" contenteditable="true">' + 
                        (program.location || '') + '</div>';
                } else if (totalClasses === 4) {
                    // 4ì°¨ì‹œ: 1-2ì°¨ì‹œ, 3-4ì°¨ì‹œ ìœ„ì¹˜ í‘œì‹œ
                    html += '<div class="program-cell" contenteditable="true">' + 
                        (program.location || '') + '</div>' +
                        '<div class="program-cell" contenteditable="true">' + 
                        (program['3-4ì°¨ì‹œìœ„ì¹˜'] || '') + '</div>';
                } else if (totalClasses === 6) {
                    // 6ì°¨ì‹œ: 1-2ì°¨ì‹œ, 3-4ì°¨ì‹œ, 5-6ì°¨ì‹œ ìœ„ì¹˜ í‘œì‹œ
                    html += '<div class="program-cell" contenteditable="true">' + 
                        (program.location || '') + '</div>' +
                        '<div class="program-cell" contenteditable="true">' + 
                        (program['3-4ì°¨ì‹œìœ„ì¹˜'] || '') + '</div>' +
                        '<div class="program-cell" contenteditable="true">' + 
                        (program['5-6ì°¨ì‹œìœ„ì¹˜'] || '') + '</div>';
                }

                html += '</div>';
            }

            // ì§„ë¡œì²´í—˜ì˜ ê²½ìš° í”„ë¡œê·¸ë¨ ìˆ˜ ì²´í¬
            if (!isAIEducation) {
                var expectedPrograms = Math.ceil(totalClasses / 2);
                if (planData.programs.length < expectedPrograms) {
                    // ë¶€ì¡±í•œ í”„ë¡œê·¸ë¨ ìˆ˜ë§Œí¼ ë¹ˆì¹¸ì˜¤ë¥˜ í–‰ ì¶”ê°€
                    for (var i = planData.programs.length; i < expectedPrograms; i++) {
                        html += '<div class="program-row" style="background-color: #ffebee;">' +
                            '<div class="program-cell" contenteditable="true">ë¹ˆì¹¸ì˜¤ë¥˜</div>' +
                            '<div class="program-cell" contenteditable="true"></div>';
                        
                        if (totalClasses === 4) {
                            html += '<div class="program-cell" contenteditable="true"></div>' +
                                '<div class="program-cell" contenteditable="true"></div>';
                        } else if (totalClasses === 6) {
                            html += '<div class="program-cell" contenteditable="true"></div>' +
                                '<div class="program-cell" contenteditable="true"></div>' +
                                '<div class="program-cell" contenteditable="true"></div>';
                        } else {
                            html += '<div class="program-cell" contenteditable="true"></div>';
                        }
                        
                        html += '</div>';
                    }
                }
            }

            html += '</div>' +
                '<div class="note-box">í”„ë¡œê·¸ë¨ê³¼ êµì‹¤ì„ í™•ì¸í•´ì£¼ì„¸ìš”.<br>â€» í•™êµì¸¡ì—ì„œ ë°°ì •í•œ êµì‹¤ë¡œ ë‹¹ì¼ ìˆ˜ì—… ì´ë™ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</div>' +
                '</div>';
            
            // ì‹œê°„í‘œ ì„¹ì…˜ ì¶”ê°€
            html += '<div class="section">' +
                '<div class="section-title">ì‹œê°„í‘œ</div>' +
                '<div class="schedule-grid">' +
                '<div class="schedule-header">' +
                '<div>ì‹œê°„</div>' +
                '<div>ë‚´ìš©</div>' +
                '</div>';

            // ì‹œê°„í‘œ í–‰ ìƒì„±
            for (var i = 0; i < planData.schedule.length; i++) {
                var item = planData.schedule[i];
                html += '<div class="schedule-row">' +
                    '<div class="schedule-cell">' + item.time + '</div>' +
                    '<div class="schedule-cell" contenteditable="true">' + item.content + '</div>' +
                    '</div>';
            }

            html += '</div>' +
                '<div class="note-box">ì¼ì •ì„ í™•ì¸ í•´ì£¼ì„¸ìš”.<br>â€»ì‹œê°„ì€ í˜„ì¥ ìƒí™©ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                
                '<div class="download-section">' +
                '<button class="save-btn" onclick="saveEdits()">ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥</button>' +
                '<button class="download-btn" onclick="downloadAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>' +
                '<button class="download-btn" onclick="generatePDF()">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>' +
                '</div>';
            
            resultDiv.innerHTML = html;
        }

        function saveEdits() {
            var infoCells = document.querySelectorAll('.info-content[contenteditable="true"]');
            planData.school.name = infoCells[0].textContent;
            planData.school.date = infoCells[1].textContent;
            planData.school.target = infoCells[2].textContent;
            planData.school.time = infoCells[3].textContent;
            planData.school.location = infoCells[4].textContent;
            planData.school.contact = infoCells[5].textContent;

            var programCells = document.querySelectorAll('.program-cell[contenteditable="true"]');
            planData.programs = [];
            for (var i = 0; i < programCells.length; i += 3) {
                planData.programs.push({
                    name: programCells[i].textContent,
                    instructor: programCells[i + 1].textContent,
                    location: programCells[i + 2].textContent
                });
            }

            var scheduleCells = document.querySelectorAll('.schedule-cell[contenteditable="true"]');
            planData.schedule = [];
            for (var i = 0; i < scheduleCells.length; i += 2) {
                planData.schedule.push({
                    time: scheduleCells[i].textContent,
                    content: scheduleCells[i + 1].textContent
                });
            }

            alert('ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function generateScheduleFromTime(timeRange, totalClasses, schoolType) {
            var schedule = [];
            var timeParts = timeRange.split(' ~ ');
            if (timeParts.length !== 2) {
                return [
                    { time: '8:20', content: 'í•™êµ ë„ì°©' },
                    { time: '8:50 ~ 9:35', content: 'ì§„ë¡œì²´í—˜ ë° ì§„ë¡œêµìœ¡ (1)' },
                    { time: '9:35 ~ 9:45', content: 'ì‰¬ëŠ” ì‹œê°„' },
                    { time: '9:45 ~ 10:30', content: 'ì§„ë¡œì²´í—˜ ë° ì§„ë¡œêµìœ¡ (2)' },
                    { time: '10:30 ~ 10:40', content: 'ì‰¬ëŠ” ì‹œê°„' },
                    { time: '10:40 ~ 11:25', content: 'ì§„ë¡œì²´í—˜ ë° ì§„ë¡œêµìœ¡ (3)' },
                    { time: '11:25 ~ 11:35', content: 'ì‰¬ëŠ” ì‹œê°„' },
                    { time: '11:35 ~ 12:20', content: 'ì§„ë¡œì²´í—˜ ë° ì§„ë¡œêµìœ¡ (4)' },
                    { time: '12:20 ~', content: 'í–‰ì‚¬ ì¢…ë£Œ' }
                ];
            }
            
            var startTime = timeParts[0].trim();
            var endTime = timeParts[1].trim();
            var startParts = startTime.split(':');
            var endParts = endTime.split(':');
            var startHour = parseInt(startParts[0]);
            var startMinute = parseInt(startParts[1]);
            var endHour = parseInt(endParts[0]);
            var endMinute = parseInt(endParts[1]);

            // ë„ì°© ì‹œê°„ (30ë¶„ ì „)
            var arrivalHour = startHour;
            var arrivalMinute = startMinute - 30;
            if (arrivalMinute < 0) {
                arrivalHour -= 1;
                arrivalMinute += 60;
            }
            schedule.push({
                time: formatTimeSimple(arrivalHour, arrivalMinute),
                content: 'í•™êµ ë„ì°©'
            });

            // ìˆ˜ì—… ë° íœ´ì‹ ê³„ì‚°
            var currentHour = startHour;
            var currentMinute = startMinute;
            var lessonDuration = (schoolType === 'high') ? 50 : 
                               (schoolType === 'middle') ? 45 : 40; // ê³ ë“±í•™êµ 50ë¶„, ì¤‘í•™êµ 45ë¶„, ì´ˆë“±í•™êµ 40ë¶„
            var breakDuration = 10; // íœ´ì‹ 10ë¶„
            var lunchDuration = 45; // ì ì‹¬ì‹œê°„ 45ë¶„
            var lessonCount = totalClasses;

            for (var i = 0; i < lessonCount; i++) {
                var lessonStartHour = currentHour;
                var lessonStartMinute = currentMinute;
                var lessonEndHour = lessonStartHour;
                var lessonEndMinute = lessonStartMinute + lessonDuration;
                if (lessonEndMinute >= 60) {
                    lessonEndHour += 1;
                    lessonEndMinute -= 60;
                }
                schedule.push({
                    time: formatTimeSimple(lessonStartHour, lessonStartMinute) + ' ~ ' + formatTimeSimple(lessonEndHour, lessonEndMinute),
                    content: 'ì§„ë¡œì²´í—˜ ë° ì§„ë¡œêµìœ¡ (' + (i + 1) + ')'
                });

                // 6ì°¨ì‹œì¼ ë•Œ 4êµì‹œ í›„ ì ì‹¬ì‹œê°„ ì¶”ê°€
                if (lessonCount === 6 && i === 3) {
                    var lunchStartHour = lessonEndHour;
                    var lunchStartMinute = lessonEndMinute;
                    var lunchEndHour = lunchStartHour;
                    var lunchEndMinute = lunchStartMinute + lunchDuration;
                    if (lunchEndMinute >= 60) {
                        lunchEndHour += 1;
                        lunchEndMinute -= 60;
                    }
                    schedule.push({
                        time: formatTimeSimple(lunchStartHour, lunchStartMinute) + ' ~ ' + formatTimeSimple(lunchEndHour, lunchEndMinute),
                        content: 'ì ì‹¬ì‹œê°„'
                    });
                    currentHour = lunchEndHour;
                    currentMinute = lunchEndMinute;
                    continue; // ì ì‹¬ í›„ ë°”ë¡œ ë‹¤ìŒ êµì‹œë¡œ
                }

                // ë§ˆì§€ë§‰ ìˆ˜ì—…ì´ ì•„ë‹Œ ê²½ìš° íœ´ì‹ ì¶”ê°€
                if (i < lessonCount - 1) {
                    var breakEndHour = lessonEndHour;
                    var breakEndMinute = lessonEndMinute + breakDuration;
                    if (breakEndMinute >= 60) {
                        breakEndHour += 1;
                        breakEndMinute -= 60;
                    }
                    schedule.push({
                        time: formatTimeSimple(lessonEndHour, lessonEndMinute) + ' ~ ' + formatTimeSimple(breakEndHour, breakEndMinute),
                        content: 'ì‰¬ëŠ” ì‹œê°„'
                    });
                    currentHour = breakEndHour;
                    currentMinute = breakEndMinute;
                } else {
                    currentHour = lessonEndHour;
                    currentMinute = lessonEndMinute;
                }
            }

            // ì¢…ë£Œ
            schedule.push({
                time: formatTimeSimple(currentHour, currentMinute) + ' ~',
                content: 'í–‰ì‚¬ ì¢…ë£Œ'
            });

            return schedule;
        }

        function formatTimeSimple(hour, minute) {
            return hour + ':' + (minute < 10 ? '0' + minute : minute);
        }

        function downloadAsImage() {
            var planResult = document.querySelector('.education-plan');
            
            // ë¡œë”© í‘œì‹œ
            var loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 20px 40px;
                border-radius: 10px;
                z-index: 10000;
                font-size: 16px;
            `;
            loadingDiv.textContent = 'ê³ í•´ìƒë„ ì´ë¯¸ì§€ ìƒì„± ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
            document.body.appendChild(loadingDiv);
            
            // 3ì´ˆ ë”œë ˆì´ í›„ ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ (ë” ê¸´ ë”œë ˆì´)
            setTimeout(() => {
                // ê³ í•´ìƒë„ ì„¤ì •
                var scale = 2; // 2ë°° ìŠ¤ì¼€ì¼ë§
                var width = planResult.offsetWidth * scale;
                var height = planResult.offsetHeight * scale;
                
                domtoimage.toBlob(planResult, {
                    quality: 1.0,
                    bgcolor: '#ffffff',
                    width: width,
                    height: height,
                    style: {
                        'transform': 'scale(' + scale + ')',
                        'transform-origin': 'top left',
                        'width': planResult.offsetWidth + 'px',
                        'height': planResult.offsetHeight + 'px'
                    },
                    filter: function(node) {
                        // ë°°ê²½ ì´ë¯¸ì§€ë‚˜ ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ ì œì™¸
                        return !(node instanceof HTMLImageElement && node.src.startsWith('data:'));
                    }
                })
                .then(function(blob) {
                    var link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = selectedDate.replace(/\./g, '') + '_' + document.getElementById('schoolSelect').value + '_êµìœ¡ê³„íšì„œ_HD.png';
                    link.click();
                    
                    // ë¡œë”© í‘œì‹œ ì œê±°
                    document.body.removeChild(loadingDiv);
                })
                .catch(function(error) {
                    console.error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', error);
                    alert('ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    
                    // ë¡œë”© í‘œì‹œ ì œê±°
                    document.body.removeChild(loadingDiv);
                });
            }, 3000); // 3ì´ˆ ë”œë ˆì´ë¡œ ì¦ê°€
        }

        function generatePDF() {
            if (!planData) {
                alert('ê³„íšì„œê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ê³„íšì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            var content = generateDocContent();
            alert('PDF ìƒì„± ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤. ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”.');
        }

        function generateDocContent() {
            var content = `ì••ë„ì  ìœ ìµí•œ DREAMPLEX êµìœ¡ê³„íšì„œ\n\n`;
            content += `ğŸ“‹ ê¸°ë³¸ì‚¬í•­\n`;
            content += `- êµìœ¡ì¥ì†Œ: ${planData.school.name}\n`;
            content += `- êµìœ¡ì¼ì‹œ: ${planData.school.date}\n`;
            content += `- êµìœ¡ì§€ì—­: ${planData.school.location}\n`;
            content += `- êµìœ¡ì‹œê°„: ${planData.school.time}\n`;
            content += `- ì´ ì°¨ì‹œ: ${planData.school.totalClasses}ì°¨ì‹œ\n`;
            content += `- ë‹´ë‹¹ì: ${planData.school.contact}\n\n`;

            content += `ğŸ‘¥ í”„ë¡œê·¸ë¨ ìƒì„¸\n`;
            content += `| í”„ë¡œê·¸ë¨ | ê°•ì‚¬ | ìœ„ì¹˜ |\n`;
            content += `|----------|------|------|\n`;
            planData.programs.forEach(program => {
                content += `| ${program.name} | ${program.instructor} | ${program.location} |\n`;
            });
            content += `\nâ° ì‹œê°„ê³„íš\n`;
            content += `| ì‹œê°„ | ë‚´ìš© |\n`;
            content += `|------|------|\n`;
            planData.schedule.forEach(item => {
                content += `| ${item.time} | ${item.content} |\n`;
            });

            return content;
        }

        // êµí†µë¹„ ê³„ì‚° ê´€ë ¨ ë³€ìˆ˜
        var transportData = {
            distance: 0,
            duration: 0,
            tollFee: 0,
            fuelCost: 0,
            totalCost: 0
        };

        // ë„¤ì´ë²„ Maps API ì„¤ì •
        var NAVER_CLIENT_ID = '9mmamp7jeu';
        var NAVER_CLIENT_SECRET = '0Hn2tdicEB1HOkV3TwWusuYkZGSnADXoeZWW8EpB';

        // Google Apps Script URL (ì‹¤ì œ ë°°í¬ í›„ URLë¡œ êµì²´ í•„ìš”)
        var GAS_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';

        // êµí†µë¹„ ê³„ì‚° í•¨ìˆ˜
        function calculateTransportCost() {
            if (!planData || !planData.school) {
                showNoRouteData();
                return;
            }

            showLoadingRoute();
            
            // Google Apps Scriptë¥¼ í†µí•œ ë„¤ì´ë²„ API í˜¸ì¶œ
            var requestData = {
                origin: 'ëŒ€êµ¬ê´‘ì—­ì‹œ',
                destination: planData.school.name,
                clientId: NAVER_CLIENT_ID,
                clientSecret: NAVER_CLIENT_SECRET
            };

            // ì‹¤ì œ Google Apps Script í˜¸ì¶œ
            fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' || data.status === 'simulated') {
                    transportData = {
                        distance: data.data.distance,
                        duration: data.data.duration,
                        tollFee: data.data.tollFee,
                        fuelCost: 0,
                        totalCost: 0
                    };
                    updateTransportDisplay();
                } else {
                    // ì˜¤ë¥˜ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ì‚¬ìš©
                    simulateRouteCalculation(requestData);
                }
                hideLoadingRoute();
            })
            .catch(error => {
                console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ì‚¬ìš©
                simulateRouteCalculation(requestData);
                hideLoadingRoute();
            });
        }

        // ê²½ë¡œ ê³„ì‚° ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œë¡œëŠ” Google Apps Scriptì—ì„œ ì²˜ë¦¬)
        function simulateRouteCalculation(data) {
            // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° (ì‹¤ì œë¡œëŠ” ë„¤ì´ë²„ API ì‘ë‹µ)
            var distance = Math.floor(Math.random() * 50) + 20; // 20-70km
            var duration = Math.floor(distance * 1.5); // ë¶„ ë‹¨ìœ„
            var tollFee = distance > 30 ? Math.floor(distance * 50) : 0; // 30km ì´ìƒì‹œ í†µí–‰ë£Œ

            transportData = {
                distance: distance,
                duration: duration,
                tollFee: tollFee,
                fuelCost: 0,
                totalCost: 0
            };

            updateTransportDisplay();
            hideLoadingRoute();
        }

        // êµí†µë¹„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateTransportDisplay() {
            var fuelEfficiency = parseFloat(document.getElementById('fuelEfficiency').value);
            var fuelPrice = parseFloat(document.getElementById('fuelPrice').value);

            // ì—°ë£Œë¹„ ê³„ì‚° (ì™•ë³µ)
            var roundTripDistance = transportData.distance * 2;
            var fuelUsed = roundTripDistance / fuelEfficiency;
            var fuelCost = Math.round(fuelUsed * fuelPrice);

            // ì´ ë¹„ìš© ê³„ì‚°
            var totalCost = fuelCost + (transportData.tollFee * 2);

            transportData.fuelCost = fuelCost;
            transportData.totalCost = totalCost;

            // í™”ë©´ ì—…ë°ì´íŠ¸
            document.getElementById('destinationSchool').textContent = planData.school.name;
            document.getElementById('totalDistance').textContent = roundTripDistance + 'km';
            document.getElementById('estimatedTime').textContent = Math.floor(transportData.duration * 2 / 60) + 'ì‹œê°„ ' + (transportData.duration * 2 % 60) + 'ë¶„';
            
            document.getElementById('fuelCost').textContent = fuelCost.toLocaleString() + 'ì›';
            document.getElementById('tollCost').textContent = (transportData.tollFee * 2).toLocaleString() + 'ì›';
            document.getElementById('totalCost').textContent = totalCost.toLocaleString() + 'ì›';

            // ì¹´í’€ë¹„ ê³„ì‚°
            document.getElementById('carpool2').textContent = Math.round(totalCost / 2).toLocaleString() + 'ì›';
            document.getElementById('carpool3').textContent = Math.round(totalCost / 3).toLocaleString() + 'ì›';
            document.getElementById('carpool4').textContent = Math.round(totalCost / 4).toLocaleString() + 'ì›';

            showRouteCalculation();
        }

        // ì¹´ì¹´ì˜¤í†¡ ê³µìœ  í…ìŠ¤íŠ¸ ë³µì‚¬
        function copyKakaoText() {
            if (!transportData || transportData.totalCost === 0) {
                alert('ë¨¼ì € êµí†µë¹„ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”.');
                return;
            }

            var kakaoText = generateKakaoText();
            
            // í´ë¦½ë³´ë“œì— ë³µì‚¬
            navigator.clipboard.writeText(kakaoText).then(() => {
                alert('ì¹´ì¹´ì˜¤í†¡ìš© í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(() => {
                // í´ë°±: í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„±
                var textArea = document.createElement('textarea');
                textArea.value = kakaoText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('ì¹´ì¹´ì˜¤í†¡ìš© í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }

        // ì¹´ì¹´ì˜¤í†¡ìš© í…ìŠ¤íŠ¸ ìƒì„±
        function generateKakaoText() {
            var text = '';
            text += 'ğŸš—ğŸ’° DREAMPLEX ì¹´í’€ë¹„ ì•ˆë‚´\n';
            text += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
            text += `ğŸ“ ${planData.school.name} (${planData.school.date})\n`;
            text += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
            text += `â›½ ì™•ë³µ ì—°ë£Œë¹„: ${transportData.fuelCost.toLocaleString()}ì›\n`;
            text += `ğŸ›£ï¸ ì™•ë³µ í†µí–‰ë£Œ: ${(transportData.tollFee * 2).toLocaleString()}ì›\n`;
            text += `ğŸ’° ì´ êµí†µë¹„: ${transportData.totalCost.toLocaleString()}ì›\n`;
            text += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
            text += 'ğŸ‘¥ íƒ‘ìŠ¹ìë³„ ë¶€ë‹´ê¸ˆ:\n';
            text += `- 2ëª…: ${Math.round(transportData.totalCost / 2).toLocaleString()}ì›/ì¸\n`;
            text += `- 3ëª…: ${Math.round(transportData.totalCost / 3).toLocaleString()}ì›/ì¸\n`;
            text += `- 4ëª…: ${Math.round(transportData.totalCost / 4).toLocaleString()}ì›/ì¸\n`;
            text += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
            text += 'ğŸ’¡ ìš´ì „ ìˆ˜ê³ ë¹„ í¬í•¨ ê¸ˆì•¡ì…ë‹ˆë‹¤';
            
            return text;
        }

        // UI í‘œì‹œ í•¨ìˆ˜ë“¤
        function showRouteCalculation() {
            document.getElementById('routeCalculation').style.display = 'block';
            document.getElementById('noRouteData').style.display = 'none';
        }

        function showLoadingRoute() {
            document.getElementById('loadingRoute').style.display = 'block';
            document.getElementById('routeCalculation').style.display = 'none';
            document.getElementById('noRouteData').style.display = 'none';
        }

        function hideLoadingRoute() {
            document.getElementById('loadingRoute').style.display = 'none';
        }

        function showNoRouteData() {
            document.getElementById('routeCalculation').style.display = 'none';
            document.getElementById('loadingRoute').style.display = 'none';
            document.getElementById('noRouteData').style.display = 'block';
        }

        // ì—°ë¹„/ìœ ë¥˜ë¹„ ì„¤ì • ë³€ê²½ ì‹œ ì¬ê³„ì‚°
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('fuelEfficiency').addEventListener('change', function() {
                if (transportData.totalCost > 0) {
                    updateTransportDisplay();
                }
            });
            
            document.getElementById('fuelPrice').addEventListener('change', function() {
                if (transportData.totalCost > 0) {
                    updateTransportDisplay();
                }
            });
        });

        // Google Apps Script ì—°ë™ í•¨ìˆ˜ë“¤
        function callGoogleAppsScript(requestData) {
            // Google Apps Script URL (ì‹¤ì œ ë°°í¬ í›„ URLë¡œ êµì²´ í•„ìš”)
            var GAS_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
            
            return fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .catch(error => {
                console.error('Google Apps Script í˜¸ì¶œ ì˜¤ë¥˜:', error);
                return null;
            });
        }

        // ë„¤ì´ë²„ Maps API ì§ì ‘ í˜¸ì¶œ (CORS ìš°íšŒìš©)
        function callNaverMapsAPI(origin, destination) {
            // ë„¤ì´ë²„ Maps API ì§ì ‘ í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜
            // ì‹¤ì œë¡œëŠ” Google Apps Scriptë¥¼ í†µí•´ í˜¸ì¶œí•´ì•¼ í•¨
            return new Promise((resolve) => {
                setTimeout(() => {
                    // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°
                    var distance = Math.floor(Math.random() * 50) + 20; // 20-70km
                    var duration = Math.floor(distance * 1.5); // ë¶„ ë‹¨ìœ„
                    var tollFee = calculateTollFee(distance);
                    
                    resolve({
                        status: 'success',
                        data: {
                            distance: distance,
                            duration: duration,
                            tollFee: tollFee
                        }
                    });
                }, 1000);
            });
        }

        // í†µí–‰ë£Œ ê³„ì‚° í•¨ìˆ˜
        function calculateTollFee(distance) {
            if (distance <= 30) {
                return 0; // 30km ì´í•˜ ë¬´ë£Œ
            } else if (distance <= 50) {
                return Math.round(distance * 30); // 30-50km: kmë‹¹ 30ì›
            } else {
                return Math.round(distance * 50); // 50km ì´ìƒ: kmë‹¹ 50ì›
            }
        }

        // êµí†µë¹„ ê³„ì‚° í•¨ìˆ˜ ìˆ˜ì •
        function calculateTransportCost() {
            if (!planData || !planData.school) {
                showNoRouteData();
                return;
            }

            showLoadingRoute();
            
            var requestData = {
                origin: 'ëŒ€êµ¬ê´‘ì—­ì‹œ',
                destination: planData.school.name,
                clientId: NAVER_CLIENT_ID,
                clientSecret: NAVER_CLIENT_SECRET
            };

            // Google Apps Script í˜¸ì¶œ ì‹œë„
            callGoogleAppsScript(requestData)
                .then(data => {
                    if (data && (data.status === 'success' || data.status === 'simulated')) {
                        transportData = {
                            distance: data.data.distance,
                            duration: data.data.duration,
                            tollFee: data.data.tollFee,
                            fuelCost: 0,
                            totalCost: 0
                        };
                        updateTransportDisplay();
                    } else {
                        // Google Apps Script ì‹¤íŒ¨ ì‹œ ë„¤ì´ë²„ API ì§ì ‘ í˜¸ì¶œ
                        return callNaverMapsAPI(requestData.origin, requestData.destination);
                    }
                })
                .then(data => {
                    if (data && data.status === 'success') {
                        transportData = {
                            distance: data.data.distance,
                            duration: data.data.duration,
                            tollFee: data.data.tollFee,
                            fuelCost: 0,
                            totalCost: 0
                        };
                        updateTransportDisplay();
                    } else {
                        // ëª¨ë“  API ì‹¤íŒ¨ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ì‚¬ìš©
                        simulateRouteCalculation(requestData);
                    }
                })
                .catch(error => {
                    console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                    simulateRouteCalculation(requestData);
                })
                .finally(() => {
                    hideLoadingRoute();
                });
        }

        // Google Apps Script ë°°í¬ ê°€ì´ë“œ í•¨ìˆ˜
        function showGoogleAppsScriptGuide() {
            var guide = `
Google Apps Script ì„¤ì • ê°€ì´ë“œ:

1. https://script.google.com/ ì ‘ì†
2. ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
3. ë‹¤ìŒ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ê¸°:

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var origin = data.origin;
    var destination = data.destination;
    var clientId = data.clientId;
    var clientSecret = data.clientSecret;
    
    var routeData = getRouteFromNaver(origin, destination, clientId, clientSecret);
    
    return ContentService.createTextOutput(JSON.stringify(routeData))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      'status': 'error',
      'message': error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function getRouteFromNaver(origin, destination, clientId, clientSecret) {
  var url = 'https://naveropenapi.apigw.ntruss.com/map-direction/v1/driving';
  var params = {
    'start': origin,
    'goal': destination,
    'avoid': 'toll'
  };
  
  var options = {
    'method': 'GET',
    'headers': {
      'X-NCP-APIGW-API-KEY-ID': clientId,
      'X-NCP-APIGW-API-KEY': clientSecret
    },
    'muteHttpExceptions': true
  };
  
  var queryString = Object.keys(params).map(function(key) {
    return key + '=' + encodeURIComponent(params[key]);
  }).join('&');
  
  var fullUrl = url + '?' + queryString;
  
  try {
    var response = UrlFetchApp.fetch(fullUrl, options);
    var responseCode = response.getResponseCode();
    var responseText = response.getContentText();
    
    if (responseCode === 200) {
      var routeData = JSON.parse(responseText);
      return processRouteData(routeData);
    } else {
      return getSimulatedRouteData(origin, destination);
    }
    
  } catch (error) {
    return getSimulatedRouteData(origin, destination);
  }
}

function processRouteData(routeData) {
  try {
    var route = routeData.route.traoptimal[0];
    var summary = route.summary;
    
    var distance = Math.round(summary.distance / 1000);
    var duration = Math.round(summary.duration / 60000);
    var tollFee = calculateTollFee(distance);
    
    return {
      'status': 'success',
      'data': {
        'distance': distance,
        'duration': duration,
        'tollFee': tollFee,
        'route': route
      }
    };
    
  } catch (error) {
    return getSimulatedRouteData('ëŒ€êµ¬ê´‘ì—­ì‹œ', 'ëª©ì ì§€');
  }
}

function calculateTollFee(distance) {
  if (distance <= 30) {
    return 0;
  } else if (distance <= 50) {
    return Math.round(distance * 30);
  } else {
    return Math.round(distance * 50);
  }
}

function getSimulatedRouteData(origin, destination) {
  var distance = Math.floor(Math.random() * 50) + 20;
  var duration = Math.floor(distance * 1.5);
  var tollFee = calculateTollFee(distance);
  
  return {
    'status': 'simulated',
    'data': {
      'distance': distance,
      'duration': duration,
      'tollFee': tollFee,
      'message': 'ì‹¤ì œ ê²½ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ì¶”ì •ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.'
    }
  };
}

4. ë°°í¬ > ìƒˆ ë°°í¬
5. ìœ í˜•: ì›¹ ì•±, ì‹¤í–‰: ë‚˜, ì•¡ì„¸ìŠ¤ ê¶Œí•œ: ëª¨ë“  ì‚¬ìš©ì
6. ë°°í¬ í›„ URLì„ ë³µì‚¬í•˜ì—¬ HTMLì˜ GAS_URLì— ì…ë ¥
            `;
            
            console.log(guide);
            alert('Google Apps Script ì„¤ì • ê°€ì´ë“œê°€ ì½˜ì†”ì— ì¶œë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. F12ë¥¼ ëˆŒëŸ¬ í™•ì¸í•˜ì„¸ìš”.');
        }
    </script>
</body>
</html>
